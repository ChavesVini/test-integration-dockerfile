name: CI and Auto Merge PR to Main

on:
  pull_request:
    branches:
      - dev
      - main

jobs:
  ci:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK (se for um projeto Java, por exemplo)
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Verify Java version
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version
          mvn -version

      - name: Install dependencies
        run: |
          mvn -f ./demo/pom.xml clean install

      - name: Run tests
        run: |
          mvn -f ./demo/pom.xml test

      - name: Get version
        id: version
        run: echo "VERSION=1.0.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Deploy via Jenkins
        shell: pwsh
        run: |
          $uri = "$env:JENKINS_URL/job/$env:JENKINS_JOB/build?token=$env:JENKINS_TOKEN"
          $pair = "$env:JENKINS_USER:$env:JENKINS_API_TOKEN"
          curl -Uri $uri -Method Post -Headers @{ Authorization = "Basic $([Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($pair)))" }
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
          JENKINS_JOB: ${{ secrets.JENKINS_JOB }}
          JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
